<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Điểm danh bằng khuôn mặt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    #camera { object-fit: cover; height: 100vh; width: 100%; }
    .info-panel { min-width: 360px; max-width: 900px; }
    #avatar { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; }
  </style>
</head>
<body class="bg-black m-0 d-flex justify-content-center">

  <!-- video camera -->
  <div class="w-100" style="max-width:1200px;">
    <video id="camera" autoplay playsinline muted></video>
  </div>

  <!-- nút chụp -->
  <button id="captureBtn"
    class="btn bg-danger text-white rounded-circle shadow position-fixed bottom-0 start-50 translate-middle-x mb-3"
    style="width:80px;height:80px;font-size:28px;z-index:1050;">
    <i class="fa-solid fa-camera"></i>
  </button>

  <!-- info panel -->
  <div id="info" class="position-fixed bottom-0 start-50 translate-middle-x mb-3 px-4 py-3 text-white rounded d-none bg-dark bg-opacity-85 info-panel"
       style="z-index:1060;">
    
    <!-- loader -->
    <div id="loader" class="text-center d-none">
      <h5 class="text-warning fw-bold mb-2">Đang kiểm tra...</h5>
      <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- result -->
    <div id="result" class="d-none">
      <!-- trạng thái -->
      <div id="statusBox" class="mb-3"></div>

      <div class="row gx-3">
        <!-- học viên -->
        <div class="col-md-6 border-end">
          <h5 class="text-success fw-bold">Thông tin học viên</h5>
          <div class="mb-2 text-center">
            <img id="avatar" src="/images/default-avatar.png" alt="Ảnh đại diện"
                 class="border border-2 border-light">
          </div>
          <p><b>Họ tên:</b> <span id="name" class="text-warning"></span></p>
          <p><b>Mã:</b> <span id="code" class="text-warning"></span></p>
          <p><b>Email:</b> <span id="email" class="text-info"></span></p>
          <p><b>SĐT:</b> <span id="phone" class="text-info"></span></p>
        </div>

        <!-- buổi học -->
        <div class="col-md-6">
          <h5 class="text-primary fw-bold">Thông tin buổi học</h5>
          <div id="classInfo" class="d-none">
            <p><b>Khóa học:</b> <span id="courseName" class="text-warning"></span></p>
            <p><b>Bài học:</b> <span id="lessonName" class="text-warning"></span></p>
            <p><b>Ngày:</b> <span id="studyDate" class="text-warning"></span></p>
            <p><b>Thời gian:</b> <span id="timeRange" class="text-warning"></span></p>
            <p><b>Phòng:</b> <span id="roomName" class="text-warning"></span></p>
          </div>
          <div id="noClass" class="d-none">
            <p class="text-danger fw-bold">⚠ Không tìm thấy buổi học nào hôm nay trong khoảng thời gian điểm danh.</p>
          </div>
        </div>
      </div>

      <!-- xác nhận -->
      <form id="confirmForm" class="mt-3">
        <input type="hidden" name="hocVienId" id="hocVienId" value="">
        <input type="hidden" name="buoiHocId" id="buoiHocId" value="">
        <div class="d-grid gap-2">
          <button id="confirmBtn" type="submit" class="btn btn-success">Xác nhận điểm danh</button>
          <button id="closeBtn" type="button" class="btn btn-secondary">Đóng</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('captureBtn');
    const infoBox = document.getElementById('info');
    const loader = document.getElementById('loader');
    const resultBox = document.getElementById('result');
    const statusBox = document.getElementById('statusBox');

    const avatarImg = document.getElementById('avatar');
    const nameSpan = document.getElementById('name');
    const codeSpan = document.getElementById('code');
    const emailSpan = document.getElementById('email');
    const phoneSpan = document.getElementById('phone');
    const courseSpan = document.getElementById('courseName');
    const lessonSpan = document.getElementById('lessonName');
    const dateSpan = document.getElementById('studyDate');
    const timeSpan = document.getElementById('timeRange');
    const roomSpan = document.getElementById('roomName');
    const classInfoBox = document.getElementById('classInfo');
    const noClassBox = document.getElementById('noClass');

    const hocVienIdInput = document.getElementById('hocVienId');
    const buoiHocIdInput = document.getElementById('buoiHocId');
    const confirmForm = document.getElementById('confirmForm');
    const confirmBtn = document.getElementById('confirmBtn');
    const closeBtn = document.getElementById('closeBtn');

    // bật camera
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();
      } catch (err) {
        showStatus("Không thể bật camera", "danger");
      }
    }
    startCamera();

    function showLoader() {
      infoBox.classList.remove('d-none');
      loader.classList.remove('d-none');
      resultBox.classList.add('d-none');
    }
    function showResult() {
      loader.classList.add('d-none');
      resultBox.classList.remove('d-none');
    }
    function hideInfo() {
      infoBox.classList.add('d-none');
      loader.classList.add('d-none');
      resultBox.classList.add('d-none');
    }
    function showStatus(msg, type="info") {
      statusBox.innerHTML = `<div class="alert alert-${type} p-2 mb-2">${msg}</div>`;
    }

    // chụp ảnh
    captureBtn.addEventListener('click', async () => {
      showLoader();
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
      const formData = new FormData();
      formData.append('face', blob, 'face.jpg');

      try {
        const resp = await fetch('/kiosk/diemdanh', { method: 'POST', body: formData });
        const data = await resp.json();

        if (!data.success) {
          if (data.hocVien) {
            fillStudentInfo(data.hocVien);
            showStatus(data.message || "Không tìm thấy buổi học.", "danger");
            noClassBox.classList.remove('d-none');
          } else {
            showStatus(data.message || "Không nhận diện được học viên", "danger");
          }
          showResult();
          return;
        }

        fillStudentInfo(data.hocVien);
        hocVienIdInput.value = data.hocVien._id;

        if (data.buoiHoc && data.khoaHoc) {
          fillClassInfo(data.khoaHoc, data.buoiHoc);
          buoiHocIdInput.value = data.buoiHoc._id;
          classInfoBox.classList.remove('d-none');
          noClassBox.classList.add('d-none');
          showStatus("Đã nhận diện thành công", "success");
        } else {
          classInfoBox.classList.add('d-none');
          noClassBox.classList.remove('d-none');
          buoiHocIdInput.value = "";
          showStatus("Không có buổi học để điểm danh", "warning");
        }
        showResult();
      } catch (err) {
        showStatus("Lỗi hệ thống khi điểm danh", "danger");
        showResult();
      }
    });

    // fill thông tin học viên
    function fillStudentInfo(hv) {
      nameSpan.textContent = hv.hoTen || "";
      codeSpan.textContent = hv._id || "";
      emailSpan.textContent = hv.email || "-";
      phoneSpan.textContent = hv.soDienThoai || "-";
      avatarImg.src = hv.anhDaiDien ? hv.anhDaiDien : "/images/default-avatar.png";
    }

    // fill thông tin buổi học
    function fillClassInfo(khoaHoc, buoiHoc) {
      courseSpan.textContent = khoaHoc.tenKhoaHoc;
      lessonSpan.textContent = buoiHoc.lesson?.tenBai || "-";
      dateSpan.textContent = new Date(buoiHoc.ngayHoc).toLocaleDateString("vi-VN");
      timeSpan.textContent = `${buoiHoc.gioBatDau} - ${buoiHoc.gioKetThuc}`;
      roomSpan.textContent = buoiHoc.phongHoc?.tenPhong || "-";
    }

    // đóng
    closeBtn.addEventListener('click', () => hideInfo());

    // xác nhận
    confirmForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      confirmBtn.disabled = true;
      try {
        const resp = await fetch('/kiosk/confirm', { method: 'POST', body: new FormData(confirmForm) });
        const body = await resp.json();
        if (body.success) {
          showStatus(body.message || "Điểm danh thành công", "success");
        } else {
          showStatus(body.message || "Không thể xác nhận điểm danh", "danger");
        }
      } catch (err) {
        showStatus("Lỗi khi xác nhận điểm danh", "danger");
      } finally {
        confirmBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
